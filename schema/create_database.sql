-- Create Discogs cache database schema (optimized)
-- Run with: psql -U postgres -f 04-create-database.sql
--
-- This schema only includes columns actively queried by cache_service.py.
-- FK constraints with ON DELETE CASCADE enable single-table pruning.

-- Create database (run as superuser)
-- CREATE DATABASE discogs;

-- Connect to discogs database, then run the rest
-- \c discogs

-- Enable trigram extension for fuzzy text search
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- ============================================
-- Core tables
-- ============================================

-- Releases
CREATE TABLE IF NOT EXISTS release (
    id              integer PRIMARY KEY,
    title           text NOT NULL,
    release_year    smallint,
    artwork_url     text,
    master_id       integer          -- used by dedup, dropped after dedup copy-swap
);

-- Artists on releases
CREATE TABLE IF NOT EXISTS release_artist (
    release_id      integer NOT NULL REFERENCES release(id) ON DELETE CASCADE,
    artist_name     text NOT NULL,
    extra           integer DEFAULT 0  -- 0 = main artist, 1 = extra credit
);

-- Tracks on releases
CREATE TABLE IF NOT EXISTS release_track (
    release_id      integer NOT NULL REFERENCES release(id) ON DELETE CASCADE,
    sequence        integer NOT NULL,
    position        text,              -- "A1", "B2", etc.
    title           text NOT NULL,
    duration        text
);

-- Artists on specific tracks (for compilations)
CREATE TABLE IF NOT EXISTS release_track_artist (
    release_id      integer NOT NULL REFERENCES release(id) ON DELETE CASCADE,
    track_sequence  integer NOT NULL,
    artist_name     text NOT NULL
);

-- ============================================
-- Cache metadata (for tracking data freshness)
-- ============================================

CREATE TABLE IF NOT EXISTS cache_metadata (
    release_id      integer PRIMARY KEY REFERENCES release(id) ON DELETE CASCADE,
    cached_at       timestamptz NOT NULL DEFAULT now(),
    source          text NOT NULL,  -- 'bulk_import' or 'api_fetch'
    last_validated  timestamptz
);

-- ============================================
-- Indexes
-- ============================================

-- Foreign key indexes
CREATE INDEX IF NOT EXISTS idx_release_artist_release_id ON release_artist(release_id);
CREATE INDEX IF NOT EXISTS idx_release_track_release_id ON release_track(release_id);
CREATE INDEX IF NOT EXISTS idx_release_track_artist_release_id ON release_track_artist(release_id);

-- Cache metadata indexes
CREATE INDEX IF NOT EXISTS idx_cache_metadata_cached_at ON cache_metadata(cached_at);
CREATE INDEX IF NOT EXISTS idx_cache_metadata_source ON cache_metadata(source);

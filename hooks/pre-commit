#!/usr/bin/env bash
# Pre-commit hook: run ruff check and ruff format on staged Python files.
# Install: ln -sf ../../hooks/pre-commit .git/hooks/pre-commit

set -euo pipefail

# Collect staged .py files (added, copied, modified, renamed)
staged_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.py')

if [ -z "$staged_files" ]; then
    exit 0
fi

# Use venv ruff if available, otherwise fall back to system ruff
if [ -x ".venv/bin/ruff" ]; then
    RUFF=".venv/bin/ruff"
elif command -v ruff &>/dev/null; then
    RUFF="ruff"
else
    echo "ruff not found. Install it or create a .venv with ruff."
    exit 1
fi

# shellcheck disable=SC2086
$RUFF check $staged_files || {
    echo ""
    echo "ruff check failed. Fix the issues above before committing."
    exit 1
}

# shellcheck disable=SC2086
$RUFF format --check $staged_files || {
    echo ""
    echo "ruff format check failed. Run 'ruff format .' to fix."
    exit 1
}
